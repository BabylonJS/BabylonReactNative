import Foundation
import UIKit
import MetalKit

@available(iOS 11.3, *)
final class EngineView : MTKView {
    
    //var boundsToken: NSKeyValueObservation?
    let bridge: RCTBridge!
    let jsRunLoop: RunLoop!
    var initialized = false
    
    required init(bridge: RCTBridge!, jsRunLoop: RunLoop!) {
        self.bridge = bridge
        self.jsRunLoop = jsRunLoop

        super.init(frame: .zero, device: MTLCreateSystemDefaultDevice())
        
        self.translatesAutoresizingMaskIntoConstraints = false
        self.colorPixelFormat = .bgra8Unorm_srgb
        self.depthStencilPixelFormat = .depth32Float
        
        self.setView()
//        let scale = Int32(UIScreen.main.scale)
//        let width = Int32(self.bounds.size.width)
//        let height = Int32(self.bounds.size.height)
        
//        self.boundsToken = self.observe(\.bounds, options: .new) { (view, change) in
//            let scale = Int32(UIScreen.main.scale)
//            let width = Int32(self.bounds.size.width)
//            let height = Int32(self.bounds.size.height)
//        }
    }
    
    override var bounds: CGRect {
        didSet {
//            let scale = Int32(UIScreen.main.scale)
//            let width = Int32(self.bounds.size.width)
//            let height = Int32(self.bounds.size.height)
            self.setView()
        }
    }
    
    required init(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    private func setView() {
        let width = self.bounds.size.width
        let height = self.bounds.size.height
        
        if (width != 0 && height != 0) {
            let scale = UIScreen.main.scale
            if (!self.initialized) {
                BabylonNativeInterop.setView(self.bridge, jsRunLoop: self.jsRunLoop, mktView: Unmanaged.passUnretained(self).toOpaque(), width: Int32(width * scale), height: Int32(height * scale))
                self.initialized = true
            } else {
                // TODO: resize
            }
        }
    }
    
//    override init(frame: CGRect) {
//        super.init(frame: frame)
//    }
//
//    convenience init(bridge: RCTBridge!, jsRunLoop: RunLoop!) {
//        self.init(frame: .zero)
//
//        BabylonNativeInterop.setView(bridge, jsRunLoop: jsRunLoop, mktView: .none, width: 0, height: 0)
//    }
//
//    required init?(coder: NSCoder) {
//        fatalError("init(coder:) has not been implemented")
//    }
}
