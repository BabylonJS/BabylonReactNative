cmake_minimum_required(VERSION 3.13.2)

project(ReactNativeBabylon)
#set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall")
set(BABYLON_NATIVE_PLATFORM "Apple") # maybe not needed
#set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++17")

# configure Babylon Native to use JSC (specifically the one that is part of the React Native application)
# set(NAPI_JAVASCRIPT_ENGINE "JavaScriptCore" CACHE STRING "The JavaScript engine to power N-API")
# add_library(javascript_engine SHARED IMPORTED GLOBAL)
# set_target_properties(javascript_engine PROPERTIES IMPORTED_LOCATION "${ANDROID_JSC_LIBPATH}/${ANDROID_ABI}/libjsc.so")
# target_include_directories(javascript_engine INTERFACE "${ANDROID_JSC_INCPATH}")

set(REACTNATIVE_DIR "${CMAKE_CURRENT_LIST_DIR}/../../../react-native/")
add_subdirectory(${REACTNATIVE_DIR}/ReactCommon/jsi/jsi ${CMAKE_CURRENT_BINARY_DIR}/jsi)
target_include_directories(jsi INTERFACE ${REACTNATIVE_DIR}/ReactCommon/jsi)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/") # need this?

set(BABYLON_NATIVE_DIR "${CMAKE_CURRENT_LIST_DIR}/../submodules/BabylonNative")
#add_subdirectory(${BABYLON_NATIVE_DIR} ${BABYLON_NATIVE_DIR}/build/Android_${CMAKE_ANDROID_ARCH_ABI}/)
add_subdirectory(${BABYLON_NATIVE_DIR} ${BABYLON_NATIVE_DIR}/build/ios/) # architecture specific?

add_library(BabylonNative
    BabylonNative.cpp)

find_library(JSCORE_LIBRARY JavaScriptCore)
#set(ADDITIONAL_LIBRARIES PRIVATE z NativeXr)
#set(ADDITIONAL_LIBRARIES ${ADDITIONAL_LIBRARIES} PRIVATE ${JSCORE_LIBRARY})

target_compile_definitions(BabylonNative PRIVATE UNICODE)
target_compile_definitions(BabylonNative PRIVATE _UNICODE)

target_compile_definitions(BabylonNative PRIVATE NODE_ADDON_API_DISABLE_DEPRECATED)

target_include_directories(BabylonNative PUBLIC ".") # "public" headers should go in some other directory

target_link_libraries(BabylonNative
    z
    arcana
    jsi
    JsRuntime
    NativeWindow
    NativeEngine
    NativeInput
    Window
    ${JSCORE_LIBRARY})

set_target_properties(BabylonNative PROPERTIES
    XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC YES
    XCODE_ATTRIBUTE_IPHONEOS_DEPLOYMENT_TARGET 9.0
    XCODE_ATTRIBUTE_ENABLE_BITCODE NO
    XCODE_ATTRIBUTE_LD_RUNPATH_SEARCH_PATHS "@executable_path/Frameworks"
)