cmake_minimum_required(VERSION 3.13.2)

project(ReactNativeBabylon)
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++17")

# configure Babylon Native to use JSI
set(NAPI_JAVASCRIPT_ENGINE "JSI" CACHE STRING "The JavaScript engine to power N-API")

set(REACTNATIVE_DIR "${CMAKE_CURRENT_LIST_DIR}/../../../react-native/")
add_subdirectory(${REACTNATIVE_DIR}/ReactCommon/jsi/jsi ${CMAKE_CURRENT_BINARY_DIR}/jsi)
target_include_directories(jsi INTERFACE ${REACTNATIVE_DIR}/ReactCommon/jsi)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/")

set(BABYLON_NATIVE_DIR "${CMAKE_CURRENT_LIST_DIR}/../submodules/BabylonNative")
add_subdirectory(${BABYLON_NATIVE_DIR} ${BABYLON_NATIVE_DIR}/build/ios/)

add_library(BabylonNative
    ${CMAKE_CURRENT_LIST_DIR}/BabylonNative.h
    ${CMAKE_CURRENT_LIST_DIR}/BabylonNative.cpp
    ${CMAKE_CURRENT_LIST_DIR}/../JSCRuntime.cpp)

find_library(JSCORE_LIBRARY JavaScriptCore)

target_compile_definitions(BabylonNative PRIVATE UNICODE)
target_compile_definitions(BabylonNative PRIVATE _UNICODE)

target_include_directories(BabylonNative PUBLIC ${CMAKE_CURRENT_LIST_DIR})

target_link_libraries(BabylonNative
    z
    arcana
    jsi
    JsRuntime
    NativeWindow
    NativeEngine
    NativeInput
    NativeXr
    Window
    ${JSCORE_LIBRARY})

# TODO: For some reason these don't work, so we specify these in the CMake command line args.
set_target_properties(BabylonNative PROPERTIES
    XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC NO
    XCODE_ATTRIBUTE_IPHONEOS_DEPLOYMENT_TARGET 12.0
    XCODE_ATTRIBUTE_ENABLE_BITCODE YES
)